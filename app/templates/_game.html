<table class="table table-hover" id="game-{{ game.id }}">
    <tr>
        <td width="70px">
            <a href="{{ game.igdb_url }}"> 
                {% if game.image_url %} 
                <img src="{{ game.image_url }}" />
                {% else %}
                <img src="https://images.igdb.com/igdb/image/upload/t_thumb/nocover.jpg" />
                {% endif %}
            </a>
        </td>
        <td>
            {{ game.name }} 
            {% if game.release_year %} 
            ({{ game.release_year }})
            {% else %}
            (Unknown Release Date)
            {% endif %}
        </td>
        <td align="center">
            {{ game.id }}
        </td>
        <td align="right">
            <p>
                {% if not current_user.is_playing(game) %}
                <button id="button-{{ game.id }}" type="button" class="btn btn-primary" 
                    onclick="togglePlay('{{ game.id }}', true)">Play</button>
                {% else %}
                <button id="button-{{ game.id }}" type="button" class="btn btn-primary" 
                    onclick="togglePlay('{{ game.id }}', false)">Unplay</button>
                {% endif %}
            </p>
        </td>
    </tr>
</table>

{% block more_js %}
<script>
    function displayFlashMessage(message, category) {
        const flashMessageContainer = document.getElementById('flash-message-container');

        const flashMessageDiv = document.createElement('div');
        flashMessageDiv.classList.add('alert');
        flashMessageDiv.classList.add(`alert-${category}`);
        flashMessageDiv.textContent = message;

        flashMessageContainer.appendChild(flashMessageDiv);

        // Auto-dismiss the flash message after 5 seconds
        setTimeout(() => {
            flashMessageDiv.style.display = 'none';
        }, 5000);
    }
    function togglePlay(gameId, isPlaying) {
        const action = isPlaying ? 'play' : 'unplay'; // Determine the action (play/unplay)
        const button = document.getElementById(`button-${gameId}`);
        const gameElement = document.getElementById(`game-${gameId}`);

        // Send a POST request to the appropriate endpoint
        fetch(`/${action}/${gameId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // Pass the CSRF token
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Toggle the button text and behavior
                if (isPlaying) {
                    button.textContent = 'Unplay';
                    button.setAttribute('onclick', `togglePlay('${gameId}', false)`);
                } else {
                    button.textContent = 'Play';
                    button.setAttribute('onclick', `togglePlay('${gameId}', true)`);
                }
                // Optionally fade the game element slightly if unplayed and if current user
                if ("{{ user == current_user }}" == "True") {
                    if (!isPlaying) {
                        gameElement.style.opacity = 0.5; // Visual feedback
                    } else {
                        gameElement.style.opacity = 1.0; // Restore visibility
                    }
                }
                else {
                    gameElement.style.opacity = 1.0; // always 1?
                }
                if (data.message) {
                    displayFlashMessage(data.message, data.category);
                }
            } else {
                // Handle error response
                alert(`Error: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing your request.');
        });
    }
</script>
{% endblock %}